name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Verificar formato con Black
        run: |
          black --check .

      - name: Verificar imports con isort
        run: |
          isort --check-only .

      - name: Ejecutar Flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Verificar tipos con mypy
        run: |
          mypy gateway/src/ productos/src/ provedores/src/ --ignore-missing-imports
        continue-on-error: true

      - name: Ejecutar tests con pytest y coverage
        run: |
          pytest \
            --cov=gateway/src \
            --cov=productos/src \
            --cov=provedores/src \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-report=json \
            --cov-report=xml \
            --junitxml=junit.xml \
            -v

      - name: Verificar coverage m√≠nimo del 80%
        run: |
          # Crear script para verificar coverage por archivo
          cat > check_coverage.sh << 'EOF'
          #!/bin/bash
          
          COVERAGE_FILE="coverage.json"
          MIN_COVERAGE=80
          FAILED_FILES=""
          
          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "‚ùå ERROR: No se encontr√≥ el archivo de coverage"
            exit 1
          fi
          
          echo "Verificando coverage por archivo (m√≠nimo ${MIN_COVERAGE}%)..."
          echo ""
          
          # Obtener coverage total
          TOTAL_COVERAGE=$(python3 -c "import json; data=json.load(open('$COVERAGE_FILE')); print(f\"{data['totals']['percent_covered']:.1f}\")")
          
          echo "üìä Coverage General: ${TOTAL_COVERAGE}%"
          echo ""
          echo "Coverage por archivo:"
          
          # Verificar cada archivo
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          MIN_COVERAGE = 80
          failed_files = []
          
          with open('coverage.json', 'r') as f:
              data = json.load(f)
          
          for file_path, file_data in data['files'].items():
              # Ignorar archivos de tests, __init__.py, migraciones, etc.
              if any(x in file_path for x in ['test_', 'tests/', '__init__.py', 'migrations/', 'venv/', '.venv/', 'gateway/src/', 'productos/src/', 'provedores/src/']):
                  continue
              
              coverage_pct = file_data['summary']['percent_covered']
              status = "‚úÖ" if coverage_pct >= MIN_COVERAGE else "‚ùå"
              
              print(f"  {status} {file_path}: {coverage_pct:.1f}%")
              
              if coverage_pct < MIN_COVERAGE:
                  failed_files.append((file_path, coverage_pct))
          
          if failed_files:
              print("\n‚ùå Los siguientes archivos no cumplen con el coverage m√≠nimo del 80%:")
              for file_path, coverage in failed_files:
                  print(f"  ‚ùå {file_path}: {coverage:.1f}% (m√≠nimo: 80%)")
              sys.exit(1)
          else:
              print("\n‚úÖ Todos los archivos cumplen con el coverage m√≠nimo del 80%")
          PYTHON_SCRIPT
          EOF
          
          chmod +x check_coverage.sh
          ./check_coverage.sh
