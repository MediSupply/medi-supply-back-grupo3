name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Verificar formato con Black
        run: |
          black --check .

      - name: Verificar imports con isort
        run: |
          isort --check-only .

      - name: Ejecutar Flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Verificar tipos con mypy
        run: |
          mypy gateway/src/ --ignore-missing-imports
        continue-on-error: true

      - name: Ejecutar tests del gateway con pytest y coverage
        run: |
          pytest \
            --cov=gateway/src \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-report=json:coverage.json \
            --cov-report=xml:coverage.xml \
            --junitxml=junit.xml \
            gateway/tests/ \
            -v

      - name: Verificar que coverage.json existe
        run: |
          if [ ! -f "coverage.json" ]; then
            echo "‚ùå ERROR: coverage.json no fue generado"
            ls -la *.json *.xml 2>/dev/null || echo "No se encontraron archivos de coverage"
            exit 1
          fi
          echo "‚úÖ coverage.json encontrado"

      - name: Verificar coverage global m√≠nimo del 80%
        run: |
          # Verificar coverage global del gateway
          python3 << 'EOF'
          import json
          import sys
          import os
          
          COVERAGE_FILE = "coverage.json"
          MIN_COVERAGE = 80
          
          # Verificar que el archivo existe
          if not os.path.exists(COVERAGE_FILE):
              print(f"‚ùå ERROR: No se encontr√≥ el archivo de coverage: {COVERAGE_FILE}")
              print(f"Archivos en el directorio actual:")
              for f in os.listdir('.'):
                  if 'coverage' in f.lower() or f.endswith('.json'):
                      print(f"  - {f}")
              sys.exit(1)
          
          try:
              with open(COVERAGE_FILE, 'r') as f:
                  data = json.load(f)
              
              # Verificar estructura del JSON
              if 'totals' not in data:
                  print(f"‚ùå ERROR: El archivo coverage.json no tiene la estructura esperada")
                  print(f"Claves disponibles: {list(data.keys())}")
                  sys.exit(1)
              
              if 'percent_covered' not in data['totals']:
                  print(f"‚ùå ERROR: No se encontr√≥ 'percent_covered' en totals")
                  print(f"Claves en totals: {list(data['totals'].keys())}")
                  sys.exit(1)
              
              total_coverage = data['totals']['percent_covered']
              
              print(f"üìä Coverage Global del Gateway: {total_coverage:.1f}%")
              print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
              
              if total_coverage >= MIN_COVERAGE:
                  print(f"‚úÖ Coverage global cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                  sys.exit(0)
              else:
                  print(f"‚ùå Coverage global NO cumple con el m√≠nimo requerido")
                  print(f"   Actual: {total_coverage:.1f}%")
                  print(f"   M√≠nimo: {MIN_COVERAGE}%")
                  print(f"   Diferencia: {MIN_COVERAGE - total_coverage:.1f}%")
                  sys.exit(1)
                  
          except json.JSONDecodeError as e:
              print(f"‚ùå ERROR: El archivo coverage.json no es un JSON v√°lido: {e}")
              sys.exit(1)
          except KeyError as e:
              print(f"‚ùå ERROR: Clave faltante en coverage.json: {e}")
              print(f"Estructura del archivo: {json.dumps(data, indent=2)[:500]}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå ERROR al procesar coverage: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF
