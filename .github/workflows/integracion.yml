name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Verificar formato con Black
        run: |
          black --check .

      - name: Verificar imports con isort
        run: |
          isort --check-only .

      - name: Ejecutar Flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Verificar tipos con mypy
        run: |
          mypy gateway/src/ --ignore-missing-imports
        continue-on-error: true

      - name: Ejecutar tests del gateway con pytest y coverage
        run: |
          pytest \
            --cov=gateway/src \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-report=json \
            --cov-report=xml \
            --junitxml=junit.xml \
            gateway/tests/ \
            -v

      - name: Verificar coverage global m√≠nimo del 80%
        run: |
          # Verificar coverage global del gateway
          python3 << 'EOF'
          import json
          import sys
          
          COVERAGE_FILE = "coverage.json"
          MIN_COVERAGE = 80
          
          try:
              with open(COVERAGE_FILE, 'r') as f:
                  data = json.load(f)
              
              total_coverage = data['totals']['percent_covered']
              
              print(f"üìä Coverage Global del Gateway: {total_coverage:.1f}%")
              print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
              
              if total_coverage >= MIN_COVERAGE:
                  print(f"‚úÖ Coverage global cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                  sys.exit(0)
              else:
                  print(f"‚ùå Coverage global NO cumple con el m√≠nimo requerido")
                  print(f"   Actual: {total_coverage:.1f}%")
                  print(f"   M√≠nimo: {MIN_COVERAGE}%")
                  print(f"   Diferencia: {MIN_COVERAGE - total_coverage:.1f}%")
                  sys.exit(1)
                  
          except FileNotFoundError:
              print(f"‚ùå ERROR: No se encontr√≥ el archivo de coverage: {COVERAGE_FILE}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå ERROR al procesar coverage: {e}")
              sys.exit(1)
          EOF
