name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Verificar formato con Black
        run: |
          black --check .

      - name: Verificar imports con isort
        run: |
          isort --check-only .

      - name: Ejecutar Flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Verificar tipos con mypy
        run: |
          mypy gateway/src/ --ignore-missing-imports
        continue-on-error: true

      - name: Ejecutar tests del gateway con pytest y coverage
        run: |
          pytest \
            --cov=gateway/src \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-report=json \
            --cov-report=xml \
            --junitxml=junit-gateway.xml \
            gateway/tests/ \
            -v || true

      - name: Instalar Pipenv para clientes
        run: |
          pip install pipenv

      - name: Ejecutar tests de clientes con pytest y coverage
        working-directory: clientes
        env:
          PIPENV_PYTHON: python
        run: |
          pipenv install --dev --python python
          pipenv run pytest \
            --cov=src/aplicacion \
            --cov=src/dominio \
            --cov=src/infraestructura \
            --cov-config=.coveragerc \
            --cov-report=term-missing \
            --cov-report=html:../htmlcov-clientes \
            --cov-report=json:../coverage-clientes.json \
            --cov-report=xml:../coverage-clientes.xml \
            --junitxml=../junit-clientes.xml \
            tests/ \
            -v

      - name: Ejecutar tests de productos con pytest y coverage
        working-directory: productos
        env:
          PIPENV_PYTHON: python
          JWT_SECRET: "test-secret-key-with-at-least-32-characters-for-security-in-ci"
          ALGORITHM: "HS256"
        run: |
          pipenv install --dev --python python
          pipenv run pytest \
            --cov=src/aplicacion \
            --cov=src/dominio \
            --cov=src/infraestructura \
            --cov-report=term-missing \
            --cov-report=html:../htmlcov-productos \
            --cov-report=json:../coverage-productos.json \
            --cov-report=xml:../coverage-productos.xml \
            --junitxml=../junit-productos.xml \
            tests/ \
            -v

      - name: Ejecutar tests de proveedores con pytest y coverage
        working-directory: provedores
        env:
          PIPENV_PYTHON: python
          JWT_SECRET: "test-secret-key-with-at-least-32-characters-for-security-in-ci"
          ALGORITHM: "HS256"
        run: |
          pipenv install --dev --python python
          pipenv run pytest \
            --cov=src/aplicacion \
            --cov=src/dominio \
            --cov=src/infraestructura \
            --cov-report=term-missing \
            --cov-report=html:../htmlcov-proveedores \
            --cov-report=json:../coverage-proveedores.json \
            --cov-report=xml:../coverage-proveedores.xml \
            --junitxml=../junit-proveedores.xml \
            tests/ \
            -v

      - name: Verificar coverage del gateway m√≠nimo del 80%
        run: |
          python3 << 'EOF'
          import json
          import sys
          import os
          
          COVERAGE_FILE = "coverage.json"
          MIN_COVERAGE = 80
          
          if os.path.exists(COVERAGE_FILE):
              try:
                  with open(COVERAGE_FILE, 'r') as f:
                      data = json.load(f)
                  
                  total_coverage = data['totals']['percent_covered']
                  
                  print(f"üìä Coverage Global del Gateway: {total_coverage:.1f}%")
                  print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
                  
                  if total_coverage >= MIN_COVERAGE:
                      print(f"‚úÖ Coverage del Gateway cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                      sys.exit(0)
                  else:
                      print(f"‚ùå Coverage del Gateway NO cumple con el m√≠nimo requerido")
                      print(f"   Actual: {total_coverage:.1f}%")
                      print(f"   M√≠nimo: {MIN_COVERAGE}%")
                      sys.exit(1)
              except Exception as e:
                  print(f"‚ö†Ô∏è  Error al procesar coverage del gateway: {e}")
                  sys.exit(0)  # No fallar si no hay coverage del gateway
          else:
              print("‚ö†Ô∏è  No se encontr√≥ archivo de coverage del gateway, omitiendo validaci√≥n")
              sys.exit(0)
          EOF

      - name: Verificar coverage de clientes m√≠nimo del 80%
        run: |
          python3 << 'EOF'
          import json
          import sys
          import os
          
          COVERAGE_FILE = "coverage-clientes.json"
          MIN_COVERAGE = 80
          
          if os.path.exists(COVERAGE_FILE):
              try:
                  with open(COVERAGE_FILE, 'r') as f:
                      data = json.load(f)
                  
                  total_coverage = data['totals']['percent_covered']
                  
                  print(f"üìä Coverage Global de Clientes: {total_coverage:.1f}%")
                  print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
                  
                  if total_coverage >= MIN_COVERAGE:
                      print(f"‚úÖ Coverage de Clientes cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                      sys.exit(0)
                  else:
                      print(f"‚ùå Coverage de Clientes NO cumple con el m√≠nimo requerido")
                      print(f"   Actual: {total_coverage:.1f}%")
                      print(f"   M√≠nimo: {MIN_COVERAGE}%")
                      print(f"   Diferencia: {MIN_COVERAGE - total_coverage:.1f}%")
                      sys.exit(1)
              except Exception as e:
                  print(f"‚ùå ERROR al procesar coverage de clientes: {e}")
                  sys.exit(1)
          else:
              print(f"‚ùå ERROR: No se encontr√≥ el archivo de coverage de clientes: {COVERAGE_FILE}")
              sys.exit(1)
          EOF

      - name: Verificar coverage de productos m√≠nimo del 80%
        run: |
          python3 << 'EOF'
          import json
          import sys
          import os
          
          COVERAGE_FILE = "coverage-productos.json"
          MIN_COVERAGE = 80
          
          if os.path.exists(COVERAGE_FILE):
              try:
                  with open(COVERAGE_FILE, 'r') as f:
                      data = json.load(f)
                  
                  total_coverage = data['totals']['percent_covered']
                  
                  print(f"üìä Coverage Global de Productos: {total_coverage:.1f}%")
                  print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
                  
                  if total_coverage >= MIN_COVERAGE:
                      print(f"‚úÖ Coverage de Productos cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                      sys.exit(0)
                  else:
                      print(f"‚ùå Coverage de Productos NO cumple con el m√≠nimo requerido")
                      print(f"   Actual: {total_coverage:.1f}%")
                      print(f"   M√≠nimo: {MIN_COVERAGE}%")
                      print(f"   Diferencia: {MIN_COVERAGE - total_coverage:.1f}%")
                      sys.exit(1)
              except Exception as e:
                  print(f"‚ùå ERROR al procesar coverage de productos: {e}")
                  sys.exit(1)
          else:
              print(f"‚ùå ERROR: No se encontr√≥ el archivo de coverage de productos: {COVERAGE_FILE}")
              sys.exit(1)
          EOF

      - name: Verificar coverage de proveedores m√≠nimo del 80%
        run: |
          python3 << 'EOF'
          import json
          import sys
          import os
          
          COVERAGE_FILE = "coverage-proveedores.json"
          MIN_COVERAGE = 80
          
          if os.path.exists(COVERAGE_FILE):
              try:
                  with open(COVERAGE_FILE, 'r') as f:
                      data = json.load(f)
                  
                  total_coverage = data['totals']['percent_covered']
                  
                  print(f"üìä Coverage Global de Proveedores: {total_coverage:.1f}%")
                  print(f"üéØ Coverage M√≠nimo Requerido: {MIN_COVERAGE}%")
                  
                  if total_coverage >= MIN_COVERAGE:
                      print(f"‚úÖ Coverage de Proveedores cumple con el m√≠nimo requerido ({MIN_COVERAGE}%)")
                      sys.exit(0)
                  else:
                      print(f"‚ùå Coverage de Proveedores NO cumple con el m√≠nimo requerido")
                      print(f"   Actual: {total_coverage:.1f}%")
                      print(f"   M√≠nimo: {MIN_COVERAGE}%")
                      print(f"   Diferencia: {MIN_COVERAGE - total_coverage:.1f}%")
                      sys.exit(1)
              except Exception as e:
                  print(f"‚ùå ERROR al procesar coverage de proveedores: {e}")
                  sys.exit(1)
          else:
              print(f"‚ùå ERROR: No se encontr√≥ el archivo de coverage de proveedores: {COVERAGE_FILE}")
              sys.exit(1)
          EOF
